function transposeSemitones(s,e,r,n){return void 0===n&&(n=defaultFormatter),transpose(s,e,semitoneMapper(r),n)}function transposeToKey(s,e,r,n){return void 0===n&&(n=defaultFormatter),transpose(s,e,function(){return r},n)}function semitoneMapper(s){return function(e){return transposeKey(e,s)}}function transpose(s,e,r,n){function t(s){try{chord=f[s.chord],suffix=void 0===s.suffix?"":s.suffix,bass=void 0===s.bass?"":f[s.bass]}catch(e){return alert(e),""}return y=bass?chord+suffix+"/"+bass:chord+suffix}function o(s,e){d[m[x]]={},d[m[x]].symbol=s,d[m[x]].colour=e}var a,i,f,u="",l=0,d={},c=s.split("\n");for(e&&(a=r(e),console(a),f=transpositionMap(e,a)),k=0;k<c.length;k++){for(var p="",h=0,b=0,m=c[k].split(/(\s+)/g),x=0;x<m.length;x++)if(""===$.trim(m[x]))p+=m[x];else if(m[x]in d)p+=n(d[m[x]].symbol,d[m[x]].colour),h++;else if(chordPattern.test(m[x])){i=XRegExp.exec(m[x],chordPattern),e||(e="m"==i.suffix||"min"==i.suffix?minors[i.chord]:i.chord,a=r(e),f=transpositionMap(e,a));var y=t(i);o(y,l),p+=n(y,l),l++,h++}else p+=m[x],b++;u+=h>b/2?p:c[k],u+="\n"}return[u,a,semitonesBetween(e,a)]}function transpositionMap(s,e){var r={};semitones=semitonesBetween(s,e),scale=keys[e].flats>0?flats:sharps;for(var n=0;N_KEYS>n;n++)r[flats[n]]=scale[(n+semitones+N_KEYS)%N_KEYS],r[sharps[n]]=scale[(n+semitones+N_KEYS)%N_KEYS];return r}function semitonesBetween(s,e){if(!(s in keys))throw s+" is not a valid key signature!";if(!(e in keys))throw e+" is not a valid key signature!";return keys[e].index-keys[s].index}function transposeKey(s,e){if(!(s in keys))throw s+" is not a valid key signature!";var r=(keys[s].index+e+N_KEYS)%N_KEYS;for(var n in keys)if(keys[n].index==r)return n;return null}function chordSpanFormatter(s,e){return colour=colours[e%colours.length],"<span class='chord' style='color: #"+colour+"'>"+s+"</span>"}function defaultFormatter(s){return s}var flats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","Cb"],sharps=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],keys={C:{index:0,sharps:0,flats:0},Db:{index:1,sharps:0,flats:5},D:{index:2,sharps:2,flats:0},Eb:{index:3,sharps:0,flats:3},E:{index:4,sharps:4,flats:0},F:{index:5,sharps:0,flats:1},"F#":{index:6,sharps:6,flats:0},G:{index:7,sharps:1,flats:0},Ab:{index:8,sharps:0,flats:4},A:{index:9,sharps:3,flats:0},Bb:{index:10,sharps:0,flats:2},B:{index:11,sharps:5,flats:0}},minors={C:"Eb",Db:"F",D:"F",Eb:"Gb",E:"G",F:"Ab","F#":"A",G:"Bb",Ab:"Cb",A:"C",Bb:"Db",B:"D"},N_KEYS=12,chordPattern=XRegExp("^(?<chord>[A-G](#|b)?)(?<suffix>(\\(?(M|maj|major|m|min|minor|dim|sus|dom|aug|\\+|-|add)?\\d*\\)?)*)(\\/(?<bass>[A-G](#|b)?))?$"),colours=themes[0].colours;