function transposeSemitones(s,r,e,n){return void 0===n&&(n=defaultFormatter),transpose(s,r,semitoneMapper(e),n)}function transposeToKey(s,r,e,n){return void 0===n&&(n=defaultFormatter),transpose(s,r,function(){return e},n)}function semitoneMapper(s){return function(r){return transposeKey(r,s)}}function transpose(s,r,e,n){function t(s){try{chord=f[s.chord],suffix=void 0===s.suffix?"":s.suffix,bass=void 0===s.bass?"":f[s.bass]}catch(r){return alert(r),""}return E=bass?chord+suffix+"/"+bass:chord+suffix}function a(s,r){d[x[m]]={},d[x[m]].symbol=s,d[x[m]].colour=r}var o,i,f,l="",u=0,d={},c=s.split("\n");for(r&&(o=e(r),f=transpositionMap(r,o)),k=0;k<c.length;k++){for(var p="",h=0,b=0,x=c[k].split(/(\s+)/g),m=0;m<x.length;m++)if(""===$.trim(x[m]))p+=x[m];else if(x[m]in d)p+=n(d[x[m]].symbol,d[x[m]].colour),h++;else if(chordPattern.test(x[m])){i=XRegExp.exec(x[m],chordPattern),r||(r="m"==i.suffix[0]?minors[i.chord]:i.chord,o=e(r),f=transpositionMap(r,o));var E=t(i);a(E,u),p+=n(E,u),u++,h++}else p+=x[m],b++;l+=h>b/2?p:c[k],l+="\n"}return l}function transpositionMap(s,r){var e={};semitones=keys[r].index-keys[s].index,scale=keys[r].flats>0?flats:sharps;for(var n=0;N_KEYS>n;n++)e[flats[n]]=scale[(n+semitones+N_KEYS)%N_KEYS],e[sharps[n]]=scale[(n+semitones+N_KEYS)%N_KEYS];return e}function transposeKey(s,r){if(!(s in keys))throw s+" is not a valid key signature!";var e=(keys[s].index+r+N_KEYS)%N_KEYS;for(var n in keys)if(keys[n].index==e)return n;return null}function chordSpanFormatter(s,r){return colour=colours[r%colours.length],"<span class='chord' style='color: #"+colour+"'>"+s+"</span>"}function defaultFormatter(s){return s}var flats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","Cb"],sharps=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],keys={C:{index:0,sharps:0,flats:0},Db:{index:1,sharps:0,flats:5},D:{index:2,sharps:2,flats:0},Eb:{index:3,sharps:0,flats:3},E:{index:4,sharps:4,flats:0},F:{index:5,sharps:0,flats:1},"F#":{index:6,sharps:6,flats:0},G:{index:7,sharps:1,flats:0},Ab:{index:8,sharps:0,flats:4},A:{index:9,sharps:3,flats:0},Bb:{index:10,sharps:0,flats:2},B:{index:11,sharps:5,flats:0}},minors={C:"Eb",Db:"F",D:"F",Eb:"Gb",E:"G",F:"Ab","F#":"A",G:"Bb",Ab:"Cb",A:"C",Bb:"Db",B:"D"},N_KEYS=12,chordPattern=XRegExp("^(?<chord>[A-G](#|b)?)(?<suffix>(\\(?(M|maj|major|m|min|minor|dim|sus|dom|aug|\\+|-|add)?\\d*\\)?)*)(\\/(?<bass>[A-G](#|b)?))?$"),colours=themes[0].colours;