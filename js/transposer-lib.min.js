function transposeSemitones(s,r,e){return transpose(s,r,semitoneMapper(e),chordSpanFormatter)}function transposeToKey(s,r,e){return transpose(s,r,function(){return e},chordSpanFormatter)}function semitoneMapper(s){return function(r){return transposeKey(r,s)}}function transpose(s,r,e,n){if(s){var a,t,o,i,l,p,f,d,c=s.split(/(\s+)/g),u="",h="",x=0,m={};r&&(a=e(r),d=transpositionMap(r,a));for(var b=0;b<c.length;b++)if(c[b]in m)u+=n(m[c[b]].symbol,m[c[b]].colour),h+=m[c[b]].symbol;else if(chordPattern.test(c[b])){f=XRegExp.exec(c[b],chordPattern),r||(r=f.chord,a=e(r),d=transpositionMap(r,a));try{i=d[f.chord],l=void 0===f.suffix?"":f.suffix,p=void 0===f.bass?"":d[f.bass]}catch(y){return void alert(y)}o=p?i+l+"/"+p:i+l,t=colours[x++%colours.length],u+=n(o,t),h+=o,m[c[b]]={},m[c[b]].symbol=o,m[c[b]].colour=t}else u+=c[b],h+=c[b];return u}}function transpositionMap(s,r){var e={};semitones=keys[r].index-keys[s].index,scale=keys[r].flats>0?flats:sharps;for(var n=0;N_KEYS>n;n++)e[flats[n]]=scale[(n+semitones+N_KEYS)%N_KEYS],e[sharps[n]]=scale[(n+semitones+N_KEYS)%N_KEYS];return e}function transposeKey(s,r){if(!(s in keys))throw s+" is not a valid key signature!";var e=(keys[s].index+r+N_KEYS)%N_KEYS;for(var n in keys)if(keys[n].index==e)return n;return null}function chordSpanFormatter(s,r){return"<span class='chord' style='color: #"+r+"'>"+s+"</span>"}var flats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","Cb"],sharps=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],keys={C:{index:0,sharps:0,flats:0},Db:{index:1,sharps:0,flats:5},D:{index:2,sharps:2,flats:0},Eb:{index:3,sharps:0,flats:3},E:{index:4,sharps:4,flats:0},F:{index:5,sharps:0,flats:1},"F#":{index:6,sharps:6,flats:0},G:{index:7,sharps:1,flats:0},Ab:{index:8,sharps:0,flats:4},A:{index:9,sharps:3,flats:0},Bb:{index:10,sharps:0,flats:2},B:{index:11,sharps:5,flats:0}},N_KEYS=12,chordPattern=XRegExp("^(?<chord>[A-G](#|b)?)(?<suffix>(\\(?(M|maj|major|m|min|minor|dim|sus|dom|aug|\\+|-|add)?\\d*\\)?)*)(\\/(?<bass>[A-G](#|b)?))?$"),colours=themes[0].colours;