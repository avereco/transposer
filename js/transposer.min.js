function transpose(s,e,t,n){if(s){for(var a,r,o,l,i,c,h=s.split(/(\s+)/g),u="",d="",p=0,f={},v=0;v<h.length;v++)if(h[v]in f)u+=chordSpan(f[h[v]].symbol,f[h[v]].colour),d+=f[h[v]].symbol;else if(chordPattern.test(h[v])){c=XRegExp.exec(h[v],chordPattern),e||(e=c.chord);try{o=transposeNote(c.chord,e,t,n),l=void 0===c.suffix?"":c.suffix,i=void 0===c.bass?"":transposeNote(c.bass,e,t,n)}catch(y){return void alert(y)}r=i?o+l+"/"+i:o+l,a=colours[p++%colours.length],u+=chordSpan(r,a),d+=r,f[h[v]]={},f[h[v]].symbol=r,f[h[v]].colour=a}else u+=h[v],d+=h[v];$("#replace-original").is(":checked")&&($("#chordarea").val(d),$("#current-key").val(t)),$("#output").html(u.replace(/(?:\r\n|\r|\n)/g,"<br />"))}}function chordSpan(s,e){return"<span class='chord' style='color: #"+e+"'>"+s+"</span>"}function transposeNote(s,e,t,n){if(!(e in keys))throw e+" is not a valid key signature!";if(t&&!(t in keys))throw t+" is not a valid key signature!";if(console.log(t),console.log(n),!t&&n)t=transposeKey(e,n);else{if(!t||n)throw"Either new key or number of semitones must be given.";n=keys[t].index-keys[e].index}var a=flats.indexOf(s);if(-1==a&&(a=sharps.indexOf(s)),-1==a)throw"Note ("+s+") does not exist.";return keys[t].flats>0?flats[(a+flats.length+n)%flats.length]:sharps[(a+sharps.length+n)%sharps.length]}function transposeKey(s,e){if(!(s in keys))throw s+" is not a valid key signature!";var t=(keys[s].index+e+N_KEYS)%N_KEYS;for(var n in keys)if(keys[n].index==t)return n;return null}var flats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","Cb"],sharps=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],keys={C:{index:0,sharps:0,flats:0},Db:{index:1,sharps:0,flats:5},D:{index:2,sharps:2,flats:0},Eb:{index:3,sharps:0,flats:3},E:{index:4,sharps:4,flats:0},F:{index:5,sharps:0,flats:1},"F#":{index:6,sharps:6,flats:0},G:{index:7,sharps:1,flats:0},Ab:{index:8,sharps:0,flats:4},A:{index:9,sharps:3,flats:0},Bb:{index:10,sharps:0,flats:2},B:{index:11,sharps:5,flats:0}},N_KEYS=12,chordPattern=XRegExp("^(?<chord>[A-G](#|b)?)(?<suffix>(\\(?(M|maj|major|m|min|minor|dim|sus|dom|aug|\\+|-|add)?\\d*\\)?)*)(\\/(?<bass>[A-G](#|b)?))?$"),colours=themes[0].colours;$(document).ready(function(){$("#print-button").click(function(){window.print()}),$("#transpose-button").click(function(){var s=$("#current-key").val();"auto"==s&&(s=null);var e=$("#new-key").val();transpose($("#chordarea").val(),s,e,null)}),$("#transpose-up").click(function(){var s=$("#current-key").val();"auto"==s&&(s=null);var e=parseInt($("#semitones").val());transpose($("#chordarea").val(),s,null,e)}),$("#transpose-down").click(function(){var s=$("#current-key").val();"auto"==s&&(s=null);var e=-parseInt($("#semitones").val());transpose($("#chordarea").val(),s,null,e)}),$('[data-toggle="tooltip"]').tooltip();for(var s=0;s<themes.length;s++)$("#themes").append('<option value="'+s+'">'+themes[s].name+"</option>");$("#themes").change(function(){colours=themes[Number($("#themes option:selected").val())].colours})});